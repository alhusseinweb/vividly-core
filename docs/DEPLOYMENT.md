# Deployment Guide

## Overview
This guide covers deploying the Vividly platform to production using Railway.app.

## Prerequisites

1. **Railway Account**: Create an account at [railway.app](https://railway.app)
2. **GitHub Account**: Code repository on GitHub
3. **Environment Variables**: All required secrets configured
4. **Docker**: For local testing (optional)

## Local Development Setup

### Using Docker Compose

1. **Clone the repository**
   ```bash
   git clone https://github.com/alhusseinweb/vividly-core.git
   cd vividly-core
   ```

2. **Start services**
   ```bash
   docker-compose up -d
   ```

3. **Run migrations**
   ```bash
   docker-compose exec backend alembic upgrade head
   ```

4. **Access services**
   - Backend: http://localhost:8000
   - Frontend: http://localhost:3000
   - API Docs: http://localhost:8000/docs
   - PostgreSQL: localhost:5432
   - Redis: localhost:6379

### Manual Setup

1. **Install dependencies**
   ```bash
   cd backend
   pip install -r requirements.txt
   ```

2. **Set environment variables**
   ```bash
   cp .env.example .env
   # Edit .env with your values
   ```

3. **Run migrations**
   ```bash
   alembic upgrade head
   ```

4. **Start backend**
   ```bash
   uvicorn main:app --reload
   ```

## Railway Deployment

### Step 1: Create Railway Project

1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub"
4. Connect your GitHub account
5. Select the `vividly-core` repository

### Step 2: Configure Services

#### PostgreSQL Database

1. Click "Add Service" → "PostgreSQL"
2. Configure environment:
   - `POSTGRES_USER`: vividly
   - `POSTGRES_PASSWORD`: [Generate strong password]
   - `POSTGRES_DB`: vividly_db

#### Redis Cache

1. Click "Add Service" → "Redis"
2. Default configuration is fine

#### Backend Service

1. Click "Add Service" → "GitHub Repo"
2. Select the `vividly-core` repository
3. Configure build:
   - **Dockerfile**: `backend/Dockerfile`
   - **Build Context**: `.`

### Step 3: Set Environment Variables

In Railway project settings, add the following environment variables:

```
# Application
ENVIRONMENT=production
DEBUG=false
APP_NAME=Vividly Backend
APP_VERSION=1.0.0
LOG_LEVEL=INFO

# Database (Railway auto-generates)
DATABASE_URL=[Auto-generated by Railway]

# Redis (Railway auto-generates)
REDIS_URL=[Auto-generated by Railway]

# JWT
JWT_SECRET_KEY=[Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"]
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=15
REFRESH_TOKEN_EXPIRE_DAYS=7

# OAuth - GitHub
GITHUB_CLIENT_ID=[Your GitHub OAuth Client ID]
GITHUB_CLIENT_SECRET=[Your GitHub OAuth Client Secret]
GITHUB_REDIRECT_URI=https://[your-railway-domain]/api/auth/oauth/github/callback

# OAuth - Google
GOOGLE_CLIENT_ID=[Your Google OAuth Client ID]
GOOGLE_CLIENT_SECRET=[Your Google OAuth Client Secret]
GOOGLE_REDIRECT_URI=https://[your-railway-domain]/api/auth/oauth/google/callback

# Google Gemini API
GOOGLE_GEMINI_API_KEY=[Your Google Gemini API Key]

# Email
RESEND_API_KEY=[Your Resend API Key]

# Frontend URL
FRONTEND_URL=https://[your-frontend-domain]

# API Keys
API_KEY_SECRET=[Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"]

# Rate Limiting
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_PERIOD=60

# Firebase
FIREBASE_PROJECT_ID=[Your Firebase Project ID]
FIREBASE_PRIVATE_KEY=[Your Firebase Private Key]
FIREBASE_CLIENT_EMAIL=[Your Firebase Client Email]

# GitHub API
GITHUB_API_TOKEN=[Your GitHub Personal Access Token]

# Deployment
VERCEL_TOKEN=[Your Vercel Token]
RAILWAY_API_TOKEN=[Your Railway API Token]
```

### Step 4: Deploy

1. **Automatic Deployment**
   - Push to main branch
   - Railway automatically builds and deploys
   - Check deployment status in Railway dashboard

2. **Manual Deployment**
   - Click "Deploy" button in Railway dashboard
   - Monitor logs for any errors

### Step 5: Run Migrations

After first deployment:

1. Connect to Railway backend service
2. Run migrations:
   ```bash
   alembic upgrade head
   ```

## GitHub Actions CI/CD

### Setup

1. **Add Secrets to GitHub**
   - Go to Repository Settings → Secrets
   - Add `RAILWAY_TOKEN`
   - Add `RAILWAY_PROJECT_ID`
   - Add `RAILWAY_ENVIRONMENT_ID`

2. **Workflows**
   - `.github/workflows/test.yml` - Runs tests on push
   - `.github/workflows/deploy.yml` - Deploys to Railway on main push

### Testing Workflow

Runs on every push:
- Lint with flake8
- Type check with mypy
- Run pytest suite
- Upload coverage to Codecov

### Deployment Workflow

Runs on main branch push:
- Tests must pass first
- Builds Docker image
- Deploys to Railway
- Notifies on success/failure

## Production Checklist

- [ ] All environment variables configured
- [ ] Database migrations run successfully
- [ ] Health check endpoint responding
- [ ] API documentation accessible
- [ ] OAuth endpoints configured
- [ ] Google Gemini API key set
- [ ] Email service configured
- [ ] Rate limiting enabled
- [ ] CORS properly configured
- [ ] Logging configured
- [ ] Monitoring set up
- [ ] Backups configured
- [ ] SSL/TLS enabled
- [ ] Domain configured
- [ ] DNS records updated

## Monitoring

### Health Check
```bash
curl https://[your-railway-domain]/health
```

### Logs
- View in Railway dashboard
- Real-time log streaming
- Historical log access

### Metrics
- CPU usage
- Memory usage
- Network I/O
- Request count
- Error rate

## Troubleshooting

### Build Failures
1. Check logs in Railway dashboard
2. Verify Dockerfile syntax
3. Check environment variables
4. Verify dependencies in requirements.txt

### Runtime Errors
1. Check application logs
2. Verify database connection
3. Check Redis connection
4. Review environment variables

### Database Issues
1. Verify DATABASE_URL
2. Run migrations: `alembic upgrade head`
3. Check PostgreSQL service status
4. Verify database credentials

### OAuth Issues
1. Verify OAuth credentials
2. Check redirect URIs
3. Review OAuth logs
4. Test with curl

## Scaling

### Horizontal Scaling
- Railway automatically scales based on resource usage
- Configure scaling limits in Railway dashboard

### Vertical Scaling
- Increase CPU/Memory allocation
- Available in Railway project settings

## Backup & Recovery

### Database Backups
- Railway provides automated backups
- Configure backup frequency in settings
- Download backups from Railway dashboard

### Recovery
1. Contact Railway support
2. Request backup restoration
3. Verify data integrity

## Security

### Best Practices
1. Use strong passwords
2. Rotate API keys regularly
3. Enable 2FA on Railway account
4. Use environment variables for secrets
5. Keep dependencies updated
6. Monitor for vulnerabilities

### Updates
- Monitor GitHub for security advisories
- Update dependencies regularly
- Test updates in staging first
- Deploy to production

## Support

- Railway Documentation: https://docs.railway.app
- GitHub Issues: https://github.com/alhusseinweb/vividly-core/issues
- Email: support@vividly.app

## Additional Resources

- [Railway Documentation](https://docs.railway.app)
- [FastAPI Documentation](https://fastapi.tiangolo.com)
- [PostgreSQL Documentation](https://www.postgresql.org/docs)
- [Redis Documentation](https://redis.io/documentation)
- [Docker Documentation](https://docs.docker.com)
